Vagrant.configure("2") do |config|
	config.vm.box = "ubuntu/jammy64"

  # Best practice: desable synced folders if not needed
  config.vm.synced_folder ".", "/vagrant", disabled: true

  SERVER_HOSTNAME = "bfiguetS"
  WORKER_HOSTNAME = "bfiguetSW"
  SERVER_IP = "192.168.56.110"
  WORKER_IP = "192.168.56.111"

  # Configure global VitualBox settings
  config.vm.provider "virtualbox" do |vb|
	vb.memory = "1024"
	vb.cpus = 1
  end

  # Common script to prepare the machine (update, basic tools, ssh, kubectl)
  COMMON_BOOTSTRAP = <<-SHELL
    set -eux  # Exit on error, exit on undefined variable and print commands being executed (for debugging)

	# Update and install basic tools
	sudo apt-get update -y
	sudo apt-get install -y curl apt-transport-https gnupg lsb-release

	# Install kubectl (official binary)
	KUBECTL_VERSION=$(curl -sL https://dl.k8s.io/release/stable.txt)
    curl -LO "https://dl.k8s.io/release/${KUBECTL_VERSION}/bin/linux/amd64/kubectl"
    sudo install -o root -g root -m 0755 kubectl /usr/local/bin/kubectl
    rm kubectl

	# Generate SSH key if it doesn't exist
	if [ ! -f /home/vagrant/.ssh/id_rsa ]; then
		sudo -u vagrant ssh-keygen -t rsa -b 4096 -N "" -f /home/vagrant/.ssh/id_rsa
	fi

	# Permit SSH access with your private key
	chmod 700 /home/vagrant/.ssh
	chmod 600 /home/vagrant/.ssh/id_rsa
	chmod 644 /home/vagrant/.ssh/id_rsa.pub
	chown -R vagrant:vagrant /home/vagrant/.ssh
	
	# Add the public key to authorized_keys
	cat /home/vagrant/.ssh/id_rsa.pub >> /home/vagrant/.ssh/authorized_keys
    chmod 600 /home/vagrant/.ssh/authorized_keys
    chown vagrant:vagrant /home/vagrant/.ssh/authorized_keys
  SHELL

  # MACHINE 1: Server (k3s server / controller)
  config.vm.define SERVER_HOSTNAME do |server|
	server.vm.hostname = SERVER_HOSTNAME
	server.vm.network "private_network", ip: SERVER_IP

	# Create .ssh directory and upload keys
	server.vm.provision "shell", inline: "mkdir -p /home/vagrant/.ssh && chown vagrant:vagrant /home/vagrant/.ssh"
	server.vm.provision "shell", inline: "chmod 600 /home/vagrant/.ssh/id_rsa && chmod 644 /home/vagrant/.ssh/id_rsa.pub && chown -R vagrant:vagrant /home/vagrant/.ssh"

	# Server provisioning script
	server.vm.provision "shell", inline: <<-SHELL
	  #{COMMON_BOOTSTRAP}
	  set -eux

	  # Installing k3s in server (controller) mode
	  # The network interface is forced to use the private IP address
	  export INSTALL_K3S_EXEC="server --tls-san #{SERVER_IP} --bind-address=#{SERVER_IP} --node-ip=#{SERVER_IP}"
	  curl -sfL https://get.k3s.io | sh


	  # Copy the kubeconfig file for the vagrant user
	  sudo cp /etc/rancher/k3s/k3s.yaml /home/vagrant/kubeconfig
	  sudo chown vagrant:vagrant /home/vagrant/kubeconfig
	  # Make kubectl usable directly
	  echo 'export KUBECONFIG=$HOME/kubeconfig' | sudo tee -a /home/vagrant/.bashrc

	  # Put server public key in authorized_keys (no password SSH from server to worker)
	  sudo cat /var/lib/rancher/k3s/server/token > /home/vagrant/k3s_token
	  sudo chown vagrant:vagrant /home/vagrant/k3s_token

	SHELL
  end

  # MACHINE 2: Worker (k3s agent / node)
  config.vm.define WORKER_HOSTNAME do |worker|
	worker.vm.hostname = WORKER_HOSTNAME
	worker.vm.network "private_network", ip: WORKER_IP

	# Create .ssh directory and upload keys
	worker.vm.provision "shell", inline: "mkdir -p /home/vagrant/.ssh && chown vagrant:vagrant /home/vagrant/.ssh"
	worker.vm.provision "shell", inline: "chmod 600 /home/vagrant/.ssh/id_rsa && chmod 644 /home/vagrant/.ssh/id_rsa.pub && chown -R vagrant:vagrant /home/vagrant/.ssh"

	worker.vm.provision "shell", inline: <<-SHELL
	  #{COMMON_BOOTSTRAP}
	  set -eux

	  # Retrieve the k3s token from the server
	  K3S_TOKEN=$(ssh -o StrictHostKeyChecking=no vagrant@#{SERVER_IP} 'cat /home/vagrant/k3s_token')

	  # Installing k3s in agent (node) mode
	  export K3S_URL="https://#{SERVER_IP}:6443"
	  export K3S_TOKEN="${K3S_TOKEN}"
	  export INSTALL_K3S_EXEC="agent --node-ip=#{WORKER_IP}"
	  curl -sfL https://get.k3s.io | sh

	SHELL
  end
end