Vagrant.configure("2") do |config|
  config.vm.box = "ubuntu/focal64"

  # Define a minimal k3s cluster: server and agent
  nodes = {
    "bfiguetS" => { ip: "192.168.56.110"},
    "bfiguetSW" => { ip: "192.168.56.111"}
  }

  # Loop through nodes to define them
  nodes.each do |name, opts|
    config.vm.define name do |node|
      node.vm.hostname = name
      node.vm.network "private_network", ip: opts[:ip]

      node.vm.provider "virtualbox" do |vb|
        vb.memory = 2048
        vb.cpus = 2
      end

      # Sync folder to share files between host and guest
      node.vm.synced_folder ".", "/vagrant", type: "virtualbox"

      # Install required utilities for k3s
      node.vm.provision "shell", inline: <<-SHELL
        sudo apt-get update
        sudo apt-get install -y curl socat conntrack ipset
      SHELL
    end
  end

  # ===== K3S SERVER =====
  config.vm.define "bfiguetS" do |server|
    server.vm.provision "shell", inline: <<-SHELL
	# Install k36s in server mode if not already installed
      if ! systemctl is-active --quiet k3s; then
        curl -sfL https://get.k3s.io | sh -s - --write-kubeconfig-mode 644
      fi

      # Wait until the server is ready and kubectl works
      until kubectl get nodes >/dev/null 2>&1; do
        sleep 2
      done

      # Share the k3s token with the host for agent nodes
      cp /var/lib/rancher/k3s/server/token /vagrant/k3s_token
    SHELL
  end

  # ===== K3S AGENT =====
  config.vm.define "bfiguetSW" do |worker|
    worker.vm.provision "shell", inline: <<-SHELL
      # Wait until the k3s token file is available
      until [ -f /vagrant/k3s_token ]; do
        sleep 2
      done

	  # Install k3s in agent mode, connecting to the server
      curl -sfL https://get.k3s.io | \
        K3S_URL="https://192.168.56.110:6443" \
        K3S_TOKEN="$(cat /vagrant/k3s_token)" \
        sh -
    SHELL
  end
end
