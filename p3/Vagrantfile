Vagrant.configure("2") do |config|
  # Using the Ubuntu focal64 as the base box
  config.vm.box = "ubuntu/focal64"

  # Define the network IP for the machine, its resources, and the host
  config.vm.network "private_network", type: "dhcp"

  config.vm.provider "virtualbox" do |vb|
    vb.memory = "4096"
    vb.cpus = 2
  end

  # Provisioning via a shell script
  config.vm.provision "shell", inline: <<-SHELL
    set -e

    # Update system packages
    echo "Updating system..."
    sudo apt-get update -y
    sudo apt-get upgrade -y

    # Installing required dependencies
    echo "Installing dependencies..."
    sudo apt-get install -y curl wget git apt-transport-https ca-certificates gnupg lsb-release

    # Install Docker
    echo "Installing Docker..."
    curl -fsSL https://get.docker.com -o get-docker.sh
    sh get-docker.sh
    sudo usermod -aG docker $USER
    newgrp docker

    # Install k3d
    echo "Installing k3d..."
    curl -s https://raw.githubusercontent.com/k3d-io/k3d/main/install.sh | bash

    # Install kubectl
    echo "Installing kubectl..."
    curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
    chmod +x kubectl
    sudo mv kubectl /usr/local/bin/

    echo "All tools installed!"

    # Create the K3D cluster
    echo "Creating K3D cluster..."
    k3d cluster create moncluster --agents 1 --port "8888:8888@agent[0]"

    echo "Cluster created:"
    kubectl get nodes

    # Create a namespace for Argo CD
    kubectl create namespace argocd || true

    # Install Argo CD in the created namespace
    kubectl apply -n argocd -f https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml

    echo "Waiting for Argo CD pods to be ready..."
    kubectl wait --for=condition=ready pod -n argocd --all --timeout=180s

    echo "Argo CD installed!"

    # Create a 'dev' namespace for the application
    kubectl create namespace dev || true

    # Deploy the application from the local deployment.yaml file
    kubectl apply -f /vagrant/deployment.yaml
    echo "Application deployed!"
  SHELL
end
